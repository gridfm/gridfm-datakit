
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../admittance_perturbation/">
      
      
        <link rel="next" href="../solvers/">
      
      
        
      
      
      <link rel="icon" href="../../figs/KIT_logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Process Network - gridfm-datakit</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
      <link rel="stylesheet" href="https://unpkg.com/katex@0/dist/katex.min.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#process-network" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="gridfm-datakit" class="md-header__button md-logo" aria-label="gridfm-datakit" data-md-component="logo">
      
  <img src="../../figs/KIT_logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            gridfm-datakit
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Process Network
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/gridfm/gridfm-datakit" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="gridfm-datakit" class="md-nav__button md-logo" aria-label="gridfm-datakit" data-md-component="logo">
      
  <img src="../../figs/KIT_logo.png" alt="logo">

    </a>
    gridfm-datakit
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/gridfm/gridfm-datakit" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Manual
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Manual
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/getting_started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/network/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Network
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/load_scenarios/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Load Scenarios
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/topology_perturbations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Topology Perturbations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/generation_perturbations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Generation Perturbations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/admittance_perturbations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Admittance Perturbations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/outputs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Outputs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Components
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Components
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../network/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Network
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Perturbations
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Perturbations
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../load/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Load
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../topology/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Topology
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generator_perturbation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Generator
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../admittance_perturbation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Admittance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" checked>
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Process
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Process
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Process Network
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Process Network
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pf_preprocessing" class="md-nav__link">
    <span class="md-ellipsis">
      
        pf_preprocessing
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pf_post_processing" class="md-nav__link">
    <span class="md-ellipsis">
      
        pf_post_processing
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#process_scenario_opf_mode" class="md-nav__link">
    <span class="md-ellipsis">
      
        process_scenario_opf_mode
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#process_scenario_pf_mode" class="md-nav__link">
    <span class="md-ellipsis">
      
        process_scenario_pf_mode
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#process_scenario_chunk" class="md-nav__link">
    <span class="md-ellipsis">
      
        process_scenario_chunk
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../solvers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Solvers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../save/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Save
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_5" >
        
          
          <label class="md-nav__link" for="__nav_4_5" id="__nav_4_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Utils
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Utils
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Utils
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../stats/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Stats
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../power_balance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Power Balance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../param_handler/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Param Handler
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generate/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Generate
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../validation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Validation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pf_preprocessing" class="md-nav__link">
    <span class="md-ellipsis">
      
        pf_preprocessing
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pf_post_processing" class="md-nav__link">
    <span class="md-ellipsis">
      
        pf_post_processing
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#process_scenario_opf_mode" class="md-nav__link">
    <span class="md-ellipsis">
      
        process_scenario_opf_mode
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#process_scenario_pf_mode" class="md-nav__link">
    <span class="md-ellipsis">
      
        process_scenario_pf_mode
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#process_scenario_chunk" class="md-nav__link">
    <span class="md-ellipsis">
      
        process_scenario_chunk
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="process-network">Process Network<a class="headerlink" href="#process-network" title="Permanent link">&para;</a></h1>
<p>This module provides functions for processing power networks and scenarios.</p>
<h3 id="pf_preprocessing"><code>pf_preprocessing</code><a class="headerlink" href="#pf_preprocessing" title="Permanent link">&para;</a></h3>


<div class="doc doc-object doc-function">



<a id="gridfm_datakit.process.process_network.pf_preprocessing"></a>
    <div class="doc doc-contents first">

        <p>Set variables to the results of OPF.</p>
<p>Updates the following network components with OPF results:</p>
<ul>
<li>sgen.p_mw: active power generation for static generators</li>
<li>gen.p_mw, gen.vm_pu: active power and voltage magnitude for generators</li>
</ul>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>net</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="gridfm_datakit.network.Network" href="../network/#gridfm_datakit.network.Network">Network</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The power network to preprocess.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>res</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>OPF result dictionary containing solution data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="gridfm_datakit.network.Network" href="../network/#gridfm_datakit.network.Network">Network</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Updated network with OPF results applied.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>gridfm_datakit/process/process_network.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">pf_preprocessing</span><span class="p">(</span><span class="n">net</span><span class="p">:</span> <span class="n">Network</span><span class="p">,</span> <span class="n">res</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Network</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set variables to the results of OPF.</span>

<span class="sd">    Updates the following network components with OPF results:</span>

<span class="sd">    - sgen.p_mw: active power generation for static generators</span>
<span class="sd">    - gen.p_mw, gen.vm_pu: active power and voltage magnitude for generators</span>

<span class="sd">    Args:</span>
<span class="sd">        net: The power network to preprocess.</span>
<span class="sd">        res: OPF result dictionary containing solution data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Updated network with OPF results applied.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pg</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;solution&quot;</span><span class="p">][</span><span class="s2">&quot;gen&quot;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)][</span><span class="s2">&quot;pg&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">net</span><span class="o">.</span><span class="n">baseMVA</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">idx_gens_in_service</span>
    <span class="p">]</span>
    <span class="n">vm</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;solution&quot;</span><span class="p">][</span><span class="s2">&quot;bus&quot;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">reverse_bus_index_mapping</span><span class="p">[</span><span class="n">i</span><span class="p">])][</span><span class="s2">&quot;vm&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">buses</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="p">]</span>

    <span class="n">net</span><span class="o">.</span><span class="n">Pg_gen</span> <span class="o">=</span> <span class="n">pg</span>
    <span class="n">net</span><span class="o">.</span><span class="n">Vm</span> <span class="o">=</span> <span class="n">vm</span>

    <span class="k">return</span> <span class="n">net</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="pf_post_processing"><code>pf_post_processing</code><a class="headerlink" href="#pf_post_processing" title="Permanent link">&para;</a></h3>


<div class="doc doc-object doc-function">



<a id="gridfm_datakit.process.process_network.pf_post_processing"></a>
    <div class="doc doc-contents first">

        <p>Post-process solved network results into numpy arrays for CSV export.</p>
<p>This function extracts power flow results and builds four arrays matching
the column schemas defined in <code>gridfm_datakit.utils.column_names</code>:</p>
<ul>
<li>Bus data with BUS_COLUMNS (+ DC_BUS_COLUMNS if include_dc_res=True)</li>
<li>Generator data with GEN_COLUMNS</li>
<li>Branch data with BRANCH_COLUMNS</li>
<li>Y-bus nonzero entries with [index1, index2, G, B]</li>
</ul>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>net</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="gridfm_datakit.network.Network" href="../network/#gridfm_datakit.network.Network">Network</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The power network to process (must have solved power flow results).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>res</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Power flow result dictionary containing solution data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_dc_res</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, include DC power flow voltage magnitude/angle (Vm_dc, Va_dc).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing:</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>"bus": np.ndarray with bus-level features</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>"gen": np.ndarray with generator features</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>"branch": np.ndarray with branch features and admittances</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>"Y_bus": np.ndarray with nonzero Y-bus entries</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>gridfm_datakit/process/process_network.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">pf_post_processing</span><span class="p">(</span>
    <span class="n">scenario_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">net</span><span class="p">:</span> <span class="n">Network</span><span class="p">,</span>
    <span class="n">res</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">res_dc</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">include_dc_res</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Post-process solved network results into numpy arrays for CSV export.</span>

<span class="sd">    This function extracts power flow results and builds four arrays matching</span>
<span class="sd">    the column schemas defined in `gridfm_datakit.utils.column_names`:</span>

<span class="sd">    - Bus data with BUS_COLUMNS (+ DC_BUS_COLUMNS if include_dc_res=True)</span>
<span class="sd">    - Generator data with GEN_COLUMNS</span>
<span class="sd">    - Branch data with BRANCH_COLUMNS</span>
<span class="sd">    - Y-bus nonzero entries with [index1, index2, G, B]</span>

<span class="sd">    Args:</span>
<span class="sd">        net: The power network to process (must have solved power flow results).</span>
<span class="sd">        res: Power flow result dictionary containing solution data.</span>
<span class="sd">        include_dc_res: If True, include DC power flow voltage magnitude/angle (Vm_dc, Va_dc).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary containing:</span>
<span class="sd">        - &quot;bus&quot;: np.ndarray with bus-level features</span>
<span class="sd">        - &quot;gen&quot;: np.ndarray with generator features</span>
<span class="sd">        - &quot;branch&quot;: np.ndarray with branch features and admittances</span>
<span class="sd">        - &quot;Y_bus&quot;: np.ndarray with nonzero Y-bus entries</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># --- Edge (branch) info ---</span>
    <span class="n">n_branches</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">branches</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n_cols</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">BRANCH_COLUMNS</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">DC_BRANCH_COLUMNS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">include_dc_res</span>
        <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">BRANCH_COLUMNS</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">X_branch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_branches</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">))</span>
    <span class="n">X_branch</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">scenario_index</span>
    <span class="n">X_branch</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_branches</span><span class="p">))</span>
    <span class="n">X_branch</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">branches</span><span class="p">[:,</span> <span class="n">F_BUS</span><span class="p">])</span>
    <span class="n">X_branch</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">branches</span><span class="p">[:,</span> <span class="n">T_BUS</span><span class="p">])</span>

    <span class="c1"># pf, qf, pt, qt</span>
    <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;solution&quot;</span><span class="p">][</span><span class="s2">&quot;pf&quot;</span><span class="p">]:</span>
        <span class="c1"># when solving pf, the flow of all branches is computed, so the number of branches in solution should match the number of branches in network</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;solution&quot;</span><span class="p">][</span><span class="s2">&quot;branch&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="n">n_branches</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;Number of branches in solution should match number of branches in network&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># when solving opf, the flow of only the in-service branches is computed, so the number of branches in solution should match the number of in-service branches in network</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;solution&quot;</span><span class="p">][</span><span class="s2">&quot;branch&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">idx_branches_in_service</span><span class="p">),</span> <span class="p">(</span>
            <span class="s2">&quot;Number of branches in solution should match number of branches in network&quot;</span>
        <span class="p">)</span>

    <span class="n">X_branch</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">idx_branches_in_service</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;solution&quot;</span><span class="p">][</span><span class="s2">&quot;branch&quot;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)][</span><span class="s2">&quot;pf&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">net</span><span class="o">.</span><span class="n">baseMVA</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">idx_branches_in_service</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="n">X_branch</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">idx_branches_in_service</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;solution&quot;</span><span class="p">][</span><span class="s2">&quot;branch&quot;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)][</span><span class="s2">&quot;qf&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">net</span><span class="o">.</span><span class="n">baseMVA</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">idx_branches_in_service</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="n">X_branch</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">idx_branches_in_service</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;solution&quot;</span><span class="p">][</span><span class="s2">&quot;branch&quot;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)][</span><span class="s2">&quot;pt&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">net</span><span class="o">.</span><span class="n">baseMVA</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">idx_branches_in_service</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="n">X_branch</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">idx_branches_in_service</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;solution&quot;</span><span class="p">][</span><span class="s2">&quot;branch&quot;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)][</span><span class="s2">&quot;qt&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">net</span><span class="o">.</span><span class="n">baseMVA</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">idx_branches_in_service</span>
        <span class="p">],</span>
    <span class="p">)</span>

    <span class="n">X_branch</span><span class="p">[:,</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">branches</span><span class="p">[:,</span> <span class="n">BR_R</span><span class="p">]</span>
    <span class="n">X_branch</span><span class="p">[:,</span> <span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">branches</span><span class="p">[:,</span> <span class="n">BR_X</span><span class="p">]</span>
    <span class="n">X_branch</span><span class="p">[:,</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">branches</span><span class="p">[:,</span> <span class="n">BR_B</span><span class="p">]</span>

    <span class="c1"># admittances</span>
    <span class="n">Ytt</span><span class="p">,</span> <span class="n">Yff</span><span class="p">,</span> <span class="n">Yft</span><span class="p">,</span> <span class="n">Ytf</span> <span class="o">=</span> <span class="n">branch_vectors</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">branches</span><span class="p">,</span> <span class="n">net</span><span class="o">.</span><span class="n">branches</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">X_branch</span><span class="p">[:,</span> <span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">Yff</span><span class="p">)</span>
    <span class="n">X_branch</span><span class="p">[:,</span> <span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">Yff</span><span class="p">)</span>
    <span class="n">X_branch</span><span class="p">[:,</span> <span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">Yft</span><span class="p">)</span>
    <span class="n">X_branch</span><span class="p">[:,</span> <span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">Yft</span><span class="p">)</span>
    <span class="n">X_branch</span><span class="p">[:,</span> <span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">Ytf</span><span class="p">)</span>
    <span class="n">X_branch</span><span class="p">[:,</span> <span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">Ytf</span><span class="p">)</span>
    <span class="n">X_branch</span><span class="p">[:,</span> <span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">Ytt</span><span class="p">)</span>
    <span class="n">X_branch</span><span class="p">[:,</span> <span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">Ytt</span><span class="p">)</span>

    <span class="n">X_branch</span><span class="p">[:,</span> <span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">branches</span><span class="p">[:,</span> <span class="n">TAP</span><span class="p">]</span>
    <span class="c1"># assign 1 to tap = 0</span>
    <span class="n">X_branch</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">branches</span><span class="p">[:,</span> <span class="n">TAP</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">X_branch</span><span class="p">[:,</span> <span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">branches</span><span class="p">[:,</span> <span class="n">SHIFT</span><span class="p">]</span>
    <span class="n">X_branch</span><span class="p">[:,</span> <span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">branches</span><span class="p">[:,</span> <span class="n">ANGMIN</span><span class="p">]</span>
    <span class="n">X_branch</span><span class="p">[:,</span> <span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">branches</span><span class="p">[:,</span> <span class="n">ANGMAX</span><span class="p">]</span>
    <span class="n">X_branch</span><span class="p">[:,</span> <span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">branches</span><span class="p">[:,</span> <span class="n">RATE_A</span><span class="p">]</span>
    <span class="n">X_branch</span><span class="p">[:,</span> <span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">branches</span><span class="p">[:,</span> <span class="n">BR_STATUS</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">include_dc_res</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">res_dc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pf_dc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">res_dc</span><span class="p">[</span><span class="s2">&quot;solution&quot;</span><span class="p">][</span><span class="s2">&quot;branch&quot;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)][</span><span class="s2">&quot;pf&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">net</span><span class="o">.</span><span class="n">baseMVA</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">idx_branches_in_service</span>
                <span class="p">],</span>
            <span class="p">)</span>
            <span class="n">pt_dc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">res_dc</span><span class="p">[</span><span class="s2">&quot;solution&quot;</span><span class="p">][</span><span class="s2">&quot;branch&quot;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)][</span><span class="s2">&quot;pt&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">net</span><span class="o">.</span><span class="n">baseMVA</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">idx_branches_in_service</span>
                <span class="p">],</span>
            <span class="p">)</span>
            <span class="n">X_branch</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">idx_branches_in_service</span><span class="p">,</span> <span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="n">pf_dc</span>
            <span class="n">X_branch</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">idx_branches_in_service</span><span class="p">,</span> <span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="n">pt_dc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X_branch</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">idx_branches_in_service</span><span class="p">,</span> <span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">X_branch</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">idx_branches_in_service</span><span class="p">,</span> <span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="c1"># --- Bus data ---</span>
    <span class="n">n_buses</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">buses</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n_cols</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">BUS_COLUMNS</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">DC_BUS_COLUMNS</span><span class="p">)</span> <span class="k">if</span> <span class="n">include_dc_res</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">BUS_COLUMNS</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">X_bus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_buses</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">))</span>

    <span class="c1"># --- Loads ---</span>
    <span class="n">X_bus</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">scenario_index</span>
    <span class="n">X_bus</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">buses</span><span class="p">[:,</span> <span class="n">BUS_I</span><span class="p">]</span>  <span class="c1"># bus</span>
    <span class="n">X_bus</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">buses</span><span class="p">[:,</span> <span class="n">PD</span><span class="p">]</span>
    <span class="n">X_bus</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">buses</span><span class="p">[:,</span> <span class="n">QD</span><span class="p">]</span>

    <span class="c1"># --- Generator injections</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;solution&quot;</span><span class="p">][</span><span class="s2">&quot;gen&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">idx_gens_in_service</span><span class="p">),</span> <span class="p">(</span>
        <span class="s2">&quot;Number of generators in solution should match number of generators in network&quot;</span>
    <span class="p">)</span>
    <span class="n">pg_gen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;solution&quot;</span><span class="p">][</span><span class="s2">&quot;gen&quot;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)][</span><span class="s2">&quot;pg&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">net</span><span class="o">.</span><span class="n">baseMVA</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">idx_gens_in_service</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="n">qg_gen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;solution&quot;</span><span class="p">][</span><span class="s2">&quot;gen&quot;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)][</span><span class="s2">&quot;qg&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">net</span><span class="o">.</span><span class="n">baseMVA</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">idx_gens_in_service</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="n">gen_bus</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gens</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">idx_gens_in_service</span><span class="p">,</span> <span class="n">GEN_BUS</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">Pg_bus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">gen_bus</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">pg_gen</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="n">n_buses</span><span class="p">)</span>
    <span class="n">Qg_bus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">gen_bus</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">qg_gen</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="n">n_buses</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">Pg_bus</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">buses</span><span class="p">[:,</span> <span class="n">BUS_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">PQ</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">Qg_bus</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">buses</span><span class="p">[:,</span> <span class="n">BUS_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">PQ</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">include_dc_res</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">res_dc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># check if &quot;gen&quot; key is in res_dc[&quot;solution&quot;]</span>
            <span class="k">if</span> <span class="s2">&quot;gen&quot;</span> <span class="ow">in</span> <span class="n">res_dc</span><span class="p">[</span><span class="s2">&quot;solution&quot;</span><span class="p">]:</span>
                <span class="n">pg_gen_dc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">res_dc</span><span class="p">[</span><span class="s2">&quot;solution&quot;</span><span class="p">][</span><span class="s2">&quot;gen&quot;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)][</span><span class="s2">&quot;pg&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">net</span><span class="o">.</span><span class="n">baseMVA</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">idx_gens_in_service</span>
                    <span class="p">],</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pg_gen_dc</span> <span class="o">=</span> <span class="n">apply_slack_single_gen</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">pg_gen</span><span class="p">,</span> <span class="n">Pg_bus</span><span class="p">,</span> <span class="n">pf_dc</span><span class="p">,</span> <span class="n">pt_dc</span><span class="p">)</span>
            <span class="n">Pg_bus_dc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">gen_bus</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">pg_gen_dc</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="n">n_buses</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">Pg_bus_dc</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">buses</span><span class="p">[:,</span> <span class="n">BUS_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">PQ</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">X_bus</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pg_bus</span>
    <span class="n">X_bus</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">Qg_bus</span>

    <span class="c1"># Voltage</span>
    <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;solution&quot;</span><span class="p">][</span><span class="s2">&quot;bus&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span>
        <span class="n">net</span><span class="o">.</span><span class="n">reverse_bus_index_mapping</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
    <span class="p">),</span> <span class="s2">&quot;Buses in solution should match buses in network&quot;</span>

    <span class="n">X_bus</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;solution&quot;</span><span class="p">][</span><span class="s2">&quot;bus&quot;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">reverse_bus_index_mapping</span><span class="p">[</span><span class="n">i</span><span class="p">])][</span><span class="s2">&quot;vm&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_buses</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">va</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;solution&quot;</span><span class="p">][</span><span class="s2">&quot;bus&quot;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">reverse_bus_index_mapping</span><span class="p">[</span><span class="n">i</span><span class="p">])][</span><span class="s2">&quot;va&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_buses</span><span class="p">)</span>
        <span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># convert to range [-180, 180]</span>
    <span class="n">va</span> <span class="o">=</span> <span class="p">(</span><span class="n">va</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span> <span class="o">-</span> <span class="mi">180</span>
    <span class="n">X_bus</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">va</span>

    <span class="c1"># one-hot encoding of bus type</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">buses</span><span class="p">[:,</span> <span class="n">BUS_TYPE</span><span class="p">],</span> <span class="p">[</span><span class="n">PQ</span><span class="p">,</span> <span class="n">PV</span><span class="p">,</span> <span class="n">REF</span><span class="p">])),</span> <span class="p">(</span>
        <span class="s2">&quot;Bus type should be PQ, PV, or REF, no disconnected buses (4)&quot;</span>
    <span class="p">)</span>

    <span class="n">X_bus</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_buses</span><span class="p">),</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">net</span><span class="o">.</span><span class="n">buses</span><span class="p">[:,</span> <span class="n">BUS_TYPE</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mi">1</span>  <span class="c1"># because type is 1, 2, 3, not 0, 1, 2</span>
    <span class="p">)</span>

    <span class="c1"># base_kv, min_vm_pu, max_vm_pu</span>
    <span class="n">X_bus</span><span class="p">[:,</span> <span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">buses</span><span class="p">[:,</span> <span class="n">BASE_KV</span><span class="p">]</span>
    <span class="n">X_bus</span><span class="p">[:,</span> <span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">buses</span><span class="p">[:,</span> <span class="n">VMIN</span><span class="p">]</span>
    <span class="n">X_bus</span><span class="p">[:,</span> <span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">buses</span><span class="p">[:,</span> <span class="n">VMAX</span><span class="p">]</span>

    <span class="n">X_bus</span><span class="p">[:,</span> <span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">buses</span><span class="p">[:,</span> <span class="n">GS</span><span class="p">]</span> <span class="o">/</span> <span class="n">net</span><span class="o">.</span><span class="n">baseMVA</span>
    <span class="n">X_bus</span><span class="p">[:,</span> <span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">buses</span><span class="p">[:,</span> <span class="n">BS</span><span class="p">]</span> <span class="o">/</span> <span class="n">net</span><span class="o">.</span><span class="n">baseMVA</span>

    <span class="k">if</span> <span class="n">include_dc_res</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">res_dc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">va</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">res_dc</span><span class="p">[</span><span class="s2">&quot;solution&quot;</span><span class="p">][</span><span class="s2">&quot;bus&quot;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">reverse_bus_index_mapping</span><span class="p">[</span><span class="n">i</span><span class="p">])][</span>
                        <span class="s2">&quot;va&quot;</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_buses</span><span class="p">)</span>
                <span class="p">],</span>
            <span class="p">)</span>
            <span class="c1"># convert to range [-180, 180]</span>
            <span class="n">va</span> <span class="o">=</span> <span class="p">(</span><span class="n">va</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span> <span class="o">-</span> <span class="mi">180</span>
            <span class="n">X_bus</span><span class="p">[:,</span> <span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">va</span>
            <span class="n">X_bus</span><span class="p">[:,</span> <span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pg_bus_dc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X_bus</span><span class="p">[:,</span> <span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">X_bus</span><span class="p">[:,</span> <span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="c1"># --- Generator data ---</span>

    <span class="n">n_cost</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gencosts</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">NCOST</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gencosts</span><span class="p">[:,</span> <span class="n">NCOST</span><span class="p">]</span> <span class="o">==</span> <span class="n">n_cost</span><span class="p">),</span> <span class="p">(</span>
        <span class="s2">&quot;NCOST should be the same for all generators&quot;</span>
    <span class="p">)</span>
    <span class="n">n_gens</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gens</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n_cols</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">GEN_COLUMNS</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">DC_GEN_COLUMNS</span><span class="p">)</span> <span class="k">if</span> <span class="n">include_dc_res</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">GEN_COLUMNS</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">X_gen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_gens</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">))</span>
    <span class="n">X_gen</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">scenario_index</span>
    <span class="n">X_gen</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_gens</span><span class="p">))</span>
    <span class="n">X_gen</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gens</span><span class="p">[:,</span> <span class="n">GEN_BUS</span><span class="p">]</span>
    <span class="n">X_gen</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">idx_gens_in_service</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pg_gen</span>  <span class="c1"># 0 if not in service</span>
    <span class="n">X_gen</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">idx_gens_in_service</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">qg_gen</span>  <span class="c1"># 0 if not in service</span>
    <span class="n">X_gen</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gens</span><span class="p">[:,</span> <span class="n">PMIN</span><span class="p">]</span>
    <span class="n">X_gen</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gens</span><span class="p">[:,</span> <span class="n">PMAX</span><span class="p">]</span>
    <span class="n">X_gen</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gens</span><span class="p">[:,</span> <span class="n">QMIN</span><span class="p">]</span>
    <span class="n">X_gen</span><span class="p">[:,</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gens</span><span class="p">[:,</span> <span class="n">QMAX</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">n_cost</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># order in .m file is c2, c1, c0</span>
        <span class="n">X_gen</span><span class="p">[:,</span> <span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gencosts</span><span class="p">[:,</span> <span class="n">COST</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">X_gen</span><span class="p">[:,</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gencosts</span><span class="p">[:,</span> <span class="n">COST</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">X_gen</span><span class="p">[:,</span> <span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gencosts</span><span class="p">[:,</span> <span class="n">COST</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">n_cost</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># order in .m file is c1, c0, and there is no cp2 cost</span>
        <span class="n">X_gen</span><span class="p">[:,</span> <span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gencosts</span><span class="p">[:,</span> <span class="n">COST</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">X_gen</span><span class="p">[:,</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gencosts</span><span class="p">[:,</span> <span class="n">COST</span><span class="p">]</span>
        <span class="n">X_gen</span><span class="p">[:,</span> <span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># no cp2 cost for linear cost function</span>

    <span class="k">if</span> <span class="n">n_cost</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># order in .m file is c0, and there is no cp1 or cp2 cost</span>
        <span class="n">X_gen</span><span class="p">[:,</span> <span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gencosts</span><span class="p">[:,</span> <span class="n">COST</span><span class="p">]</span>
        <span class="n">X_gen</span><span class="p">[:,</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># no cp1 cost for constant cost function</span>
        <span class="n">X_gen</span><span class="p">[:,</span> <span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># no cp2 cost for constant cost function</span>

    <span class="n">X_gen</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">idx_gens_in_service</span><span class="p">,</span> <span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># slack gen (can be any generator connected to the ref node)</span>
    <span class="n">slack_gen_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gens</span><span class="p">[:,</span> <span class="n">GEN_BUS</span><span class="p">]</span> <span class="o">==</span> <span class="n">net</span><span class="o">.</span><span class="n">ref_bus_idx</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">X_gen</span><span class="p">[</span><span class="n">slack_gen_idx</span><span class="p">,</span> <span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">include_dc_res</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">res_dc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">X_gen</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">idx_gens_in_service</span><span class="p">,</span> <span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">pg_gen_dc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X_gen</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">idx_gens_in_service</span><span class="p">,</span> <span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="c1"># --- Y-bus ---</span>
    <span class="n">Y_bus</span><span class="p">,</span> <span class="n">Yf</span><span class="p">,</span> <span class="n">Yt</span> <span class="o">=</span> <span class="n">makeYbus</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">baseMVA</span><span class="p">,</span> <span class="n">net</span><span class="o">.</span><span class="n">buses</span><span class="p">,</span> <span class="n">net</span><span class="o">.</span><span class="n">branches</span><span class="p">)</span>

    <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">Y_bus</span><span class="p">)</span>
    <span class="c1"># note that Y_bus[i,j] can be != 0 even if a branch from i to j is not in service because there might be other branches connected to the same buses</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">Y_bus</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="n">edge_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
    <span class="n">edge_attr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">G</span><span class="p">,</span> <span class="n">B</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">Y_bus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
        <span class="p">(</span><span class="n">edge_index</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge_attr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">edge_index</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">Y_bus</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">scenario_index</span>
    <span class="n">Y_bus</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">edge_index</span><span class="p">,</span> <span class="n">edge_attr</span><span class="p">))</span>

    <span class="c1"># ---- runtime data ----</span>
    <span class="n">n_cols</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">RUNTIME_COLUMNS</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">DC_RUNTIME_COLUMNS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">include_dc_res</span>
        <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">RUNTIME_COLUMNS</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">X_runtime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">))</span>
    <span class="n">X_runtime</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">scenario_index</span>
    <span class="n">X_runtime</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;solve_time&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">include_dc_res</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">res_dc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">X_runtime</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_dc</span><span class="p">[</span><span class="s2">&quot;solve_time&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X_runtime</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;bus&quot;</span><span class="p">:</span> <span class="n">X_bus</span><span class="p">,</span>
        <span class="s2">&quot;gen&quot;</span><span class="p">:</span> <span class="n">X_gen</span><span class="p">,</span>
        <span class="s2">&quot;branch&quot;</span><span class="p">:</span> <span class="n">X_branch</span><span class="p">,</span>
        <span class="s2">&quot;Y_bus&quot;</span><span class="p">:</span> <span class="n">Y_bus</span><span class="p">,</span>
        <span class="s2">&quot;runtime&quot;</span><span class="p">:</span> <span class="n">X_runtime</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="process_scenario_opf_mode"><code>process_scenario_opf_mode</code><a class="headerlink" href="#process_scenario_opf_mode" title="Permanent link">&para;</a></h3>


<div class="doc doc-object doc-function">



<a id="gridfm_datakit.process.process_network.process_scenario_opf_mode"></a>
    <div class="doc doc-contents first">

        <p>Processes a load scenario in OPF mode</p>
<p>In OPF mode, perturbations are applied first, then OPF is run to get
generator setpoints that account for the perturbed topology. This ensures
all constraints are satisfied in the final operating point.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>net</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="gridfm_datakit.network.Network" href="../network/#gridfm_datakit.network.Network">Network</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The power network.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scenarios</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Array of load scenarios with shape (n_loads, n_scenarios, 2).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scenario_index</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Index of the current scenario to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>topology_generator</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="gridfm_datakit.perturbations.topology_perturbation.TopologyGenerator" href="../topology/#gridfm_datakit.perturbations.topology_perturbation.TopologyGenerator">TopologyGenerator</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Generator for topology perturbations (line/transformer outages).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>generation_generator</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="gridfm_datakit.perturbations.generator_perturbation.GenerationGenerator" href="../generator_perturbation/#gridfm_datakit.perturbations.generator_perturbation.GenerationGenerator">GenerationGenerator</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Generator for generation cost perturbations.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>admittance_generator</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="gridfm_datakit.perturbations.admittance_perturbation.AdmittanceGenerator" href="../admittance_perturbation/#gridfm_datakit.perturbations.admittance_perturbation.AdmittanceGenerator">AdmittanceGenerator</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Generator for line admittance perturbations.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>local_processed_data</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List to accumulate processed data tuples.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>error_log_file</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to error log file for recording failures.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_dc_res</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include DC power flow results in output.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>jl</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Julia interface object for running power flow calculations.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Updated list of processed data (bus, gen, branch, Y_bus arrays)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>Random seed is controlled by the calling context (process_scenario_chunk).</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>gridfm_datakit/process/process_network.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">process_scenario_opf_mode</span><span class="p">(</span>
    <span class="n">net</span><span class="p">:</span> <span class="n">Network</span><span class="p">,</span>
    <span class="n">scenarios</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">scenario_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">topology_generator</span><span class="p">:</span> <span class="n">TopologyGenerator</span><span class="p">,</span>
    <span class="n">generation_generator</span><span class="p">:</span> <span class="n">GenerationGenerator</span><span class="p">,</span>
    <span class="n">admittance_generator</span><span class="p">:</span> <span class="n">AdmittanceGenerator</span><span class="p">,</span>
    <span class="n">local_processed_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">error_log_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">include_dc_res</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">jl</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Processes a load scenario in OPF mode</span>

<span class="sd">    In OPF mode, perturbations are applied first, then OPF is run to get</span>
<span class="sd">    generator setpoints that account for the perturbed topology. This ensures</span>
<span class="sd">    all constraints are satisfied in the final operating point.</span>

<span class="sd">    Args:</span>
<span class="sd">        net: The power network.</span>
<span class="sd">        scenarios: Array of load scenarios with shape (n_loads, n_scenarios, 2).</span>
<span class="sd">        scenario_index: Index of the current scenario to process.</span>
<span class="sd">        topology_generator: Generator for topology perturbations (line/transformer outages).</span>
<span class="sd">        generation_generator: Generator for generation cost perturbations.</span>
<span class="sd">        admittance_generator: Generator for line admittance perturbations.</span>
<span class="sd">        local_processed_data: List to accumulate processed data tuples.</span>
<span class="sd">        error_log_file: Path to error log file for recording failures.</span>
<span class="sd">        include_dc_res: Whether to include DC power flow results in output.</span>
<span class="sd">        jl: Julia interface object for running power flow calculations.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Updated list of processed data (bus, gen, branch, Y_bus arrays)</span>

<span class="sd">    Note:</span>
<span class="sd">        Random seed is controlled by the calling context (process_scenario_chunk).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># apply the load scenario to the network</span>
    <span class="n">net</span><span class="o">.</span><span class="n">Pd</span> <span class="o">=</span> <span class="n">scenarios</span><span class="p">[:,</span> <span class="n">scenario_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">net</span><span class="o">.</span><span class="n">Qd</span> <span class="o">=</span> <span class="n">scenarios</span><span class="p">[:,</span> <span class="n">scenario_index</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Generate perturbed topologies</span>
    <span class="n">perturbations</span> <span class="o">=</span> <span class="n">topology_generator</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>

    <span class="c1"># Apply generation perturbations</span>
    <span class="n">perturbations</span> <span class="o">=</span> <span class="n">generation_generator</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">perturbations</span><span class="p">)</span>

    <span class="c1"># Apply admittance perturbations</span>
    <span class="n">perturbations</span> <span class="o">=</span> <span class="n">admittance_generator</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">perturbations</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">perturbation</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="n">perturbations</span>
    <span class="p">):</span>  <span class="c1"># (that returns copies of the network with the topology perturbation applied)</span>
        <span class="n">res_dcopf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">include_dc_res</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res_dcopf</span> <span class="o">=</span> <span class="n">run_dcopf</span><span class="p">(</span><span class="n">perturbation</span><span class="p">,</span> <span class="n">jl</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">error_log_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Caught an exception at scenario </span><span class="si">{</span><span class="n">scenario_index</span><span class="si">}</span><span class="s2"> in run_dcopf function: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># run OPF to get the gen set points. Here the set points account for the topology perturbation.</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">run_opf</span><span class="p">(</span><span class="n">perturbation</span><span class="p">,</span> <span class="n">jl</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">error_log_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Caught an exception at scenario </span><span class="si">{</span><span class="n">scenario_index</span><span class="si">}</span><span class="s2"> in run_opf function: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Append processed power flow data</span>
        <span class="n">pf_data</span> <span class="o">=</span> <span class="n">pf_post_processing</span><span class="p">(</span>
            <span class="n">scenario_index</span><span class="p">,</span>
            <span class="n">perturbation</span><span class="p">,</span>
            <span class="n">res</span><span class="p">,</span>
            <span class="n">res_dcopf</span><span class="p">,</span>
            <span class="n">include_dc_res</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">local_processed_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">pf_data</span><span class="p">[</span><span class="s2">&quot;bus&quot;</span><span class="p">],</span>
                <span class="n">pf_data</span><span class="p">[</span><span class="s2">&quot;gen&quot;</span><span class="p">],</span>
                <span class="n">pf_data</span><span class="p">[</span><span class="s2">&quot;branch&quot;</span><span class="p">],</span>
                <span class="n">pf_data</span><span class="p">[</span><span class="s2">&quot;Y_bus&quot;</span><span class="p">],</span>
                <span class="n">pf_data</span><span class="p">[</span><span class="s2">&quot;runtime&quot;</span><span class="p">],</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">local_processed_data</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="process_scenario_pf_mode"><code>process_scenario_pf_mode</code><a class="headerlink" href="#process_scenario_pf_mode" title="Permanent link">&para;</a></h3>


<div class="doc doc-object doc-function">



<a id="gridfm_datakit.process.process_network.process_scenario_pf_mode"></a>
    <div class="doc doc-contents first">

        <p>Processes a load scenario in PF mode</p>
<p>In PF mode, OPF is run first to get generator setpoints, then topology
perturbations are applied. This can lead to constraint violations (overloads,
voltage violations) since the setpoints are not re-optimized for the new topology.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>net</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="gridfm_datakit.network.Network" href="../network/#gridfm_datakit.network.Network">Network</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The power network.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scenarios</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Array of load scenarios with shape (n_loads, n_scenarios, 2).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scenario_index</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Index of the current scenario to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>topology_generator</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="gridfm_datakit.perturbations.topology_perturbation.TopologyGenerator" href="../topology/#gridfm_datakit.perturbations.topology_perturbation.TopologyGenerator">TopologyGenerator</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Generator for topology perturbations (line/transformer outages).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>generation_generator</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="gridfm_datakit.perturbations.generator_perturbation.GenerationGenerator" href="../generator_perturbation/#gridfm_datakit.perturbations.generator_perturbation.GenerationGenerator">GenerationGenerator</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Generator for generation cost perturbations.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>admittance_generator</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="gridfm_datakit.perturbations.admittance_perturbation.AdmittanceGenerator" href="../admittance_perturbation/#gridfm_datakit.perturbations.admittance_perturbation.AdmittanceGenerator">AdmittanceGenerator</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Generator for line admittance perturbations.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>local_processed_data</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List to accumulate processed data tuples.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>error_log_file</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to error log file for recording failures.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_dc_res</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include DC power flow results in output.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pf_fast</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use fast AC PF solver.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dcpf_fast</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use fast DC PF solver.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>jl</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Julia interface object for running power flow calculations.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Updated list of processed data (bus, gen, branch, Y_bus arrays)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>Random seed is controlled by the calling context (process_scenario_chunk).</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>gridfm_datakit/process/process_network.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">process_scenario_pf_mode</span><span class="p">(</span>
    <span class="n">net</span><span class="p">:</span> <span class="n">Network</span><span class="p">,</span>
    <span class="n">scenarios</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">scenario_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">topology_generator</span><span class="p">:</span> <span class="n">TopologyGenerator</span><span class="p">,</span>
    <span class="n">generation_generator</span><span class="p">:</span> <span class="n">GenerationGenerator</span><span class="p">,</span>
    <span class="n">admittance_generator</span><span class="p">:</span> <span class="n">AdmittanceGenerator</span><span class="p">,</span>
    <span class="n">local_processed_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">error_log_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">include_dc_res</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">pf_fast</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">dcpf_fast</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">jl</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Processes a load scenario in PF mode</span>

<span class="sd">    In PF mode, OPF is run first to get generator setpoints, then topology</span>
<span class="sd">    perturbations are applied. This can lead to constraint violations (overloads,</span>
<span class="sd">    voltage violations) since the setpoints are not re-optimized for the new topology.</span>

<span class="sd">    Args:</span>
<span class="sd">        net: The power network.</span>
<span class="sd">        scenarios: Array of load scenarios with shape (n_loads, n_scenarios, 2).</span>
<span class="sd">        scenario_index: Index of the current scenario to process.</span>
<span class="sd">        topology_generator: Generator for topology perturbations (line/transformer outages).</span>
<span class="sd">        generation_generator: Generator for generation cost perturbations.</span>
<span class="sd">        admittance_generator: Generator for line admittance perturbations.</span>
<span class="sd">        local_processed_data: List to accumulate processed data tuples.</span>
<span class="sd">        error_log_file: Path to error log file for recording failures.</span>
<span class="sd">        include_dc_res: Whether to include DC power flow results in output.</span>
<span class="sd">        pf_fast: Whether to use fast AC PF solver.</span>
<span class="sd">        dcpf_fast: Whether to use fast DC PF solver.</span>
<span class="sd">        jl: Julia interface object for running power flow calculations.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Updated list of processed data (bus, gen, branch, Y_bus arrays)</span>

<span class="sd">    Note:</span>
<span class="sd">        Random seed is controlled by the calling context (process_scenario_chunk).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">net</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>

    <span class="c1"># apply the load scenario to the network</span>
    <span class="n">net</span><span class="o">.</span><span class="n">Pd</span> <span class="o">=</span> <span class="n">scenarios</span><span class="p">[:,</span> <span class="n">scenario_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">net</span><span class="o">.</span><span class="n">Qd</span> <span class="o">=</span> <span class="n">scenarios</span><span class="p">[:,</span> <span class="n">scenario_index</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Apply generation perturbations before OPF.</span>
    <span class="n">perturbations</span> <span class="o">=</span> <span class="n">generation_generator</span><span class="o">.</span><span class="n">generate</span><span class="p">((</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">net</span><span class="p">]))</span>

    <span class="c1"># Apply admittance perturbations</span>
    <span class="n">perturbations</span> <span class="o">=</span> <span class="n">admittance_generator</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">perturbations</span><span class="p">)</span>

    <span class="n">net</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">perturbations</span><span class="p">)</span>

    <span class="c1"># first run OPF to get the gen set points</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">run_opf</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">jl</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">error_log_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Caught an exception at scenario </span><span class="si">{</span><span class="n">scenario_index</span><span class="si">}</span><span class="s2"> in run_opf function: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">local_processed_data</span>

    <span class="n">net_pf</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>
    <span class="n">net_pf</span> <span class="o">=</span> <span class="n">pf_preprocessing</span><span class="p">(</span><span class="n">net_pf</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

    <span class="c1"># Generate perturbed topologies</span>
    <span class="n">perturbations</span> <span class="o">=</span> <span class="n">topology_generator</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">net_pf</span><span class="p">)</span>

    <span class="c1"># to get PF points that can violate some OPF inequality constraints (to train PF solvers that can handle points outside of normal operating limits), we apply the topology perturbation after OPF.</span>
    <span class="c1"># The setpoints are then no longer adapted to the new topology, and might lead to e.g. abranch overload or a voltage magnitude violation once we drop an element.</span>
    <span class="k">for</span> <span class="n">perturbation</span> <span class="ow">in</span> <span class="n">perturbations</span><span class="p">:</span>
        <span class="n">res_dcpf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">include_dc_res</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res_dcpf</span> <span class="o">=</span> <span class="n">run_dcpf</span><span class="p">(</span><span class="n">perturbation</span><span class="p">,</span> <span class="n">jl</span><span class="p">,</span> <span class="n">fast</span><span class="o">=</span><span class="n">dcpf_fast</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">error_log_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Caught an exception at scenario </span><span class="si">{</span><span class="n">scenario_index</span><span class="si">}</span><span class="s2"> when solving dcpf function: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">run_pf</span><span class="p">(</span><span class="n">perturbation</span><span class="p">,</span> <span class="n">jl</span><span class="p">,</span> <span class="n">fast</span><span class="o">=</span><span class="n">pf_fast</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">error_log_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Caught an exception at scenario </span><span class="si">{</span><span class="n">scenario_index</span><span class="si">}</span><span class="s2"> when solving in run_pf function: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Append processed power flow data</span>
        <span class="n">pf_data</span> <span class="o">=</span> <span class="n">pf_post_processing</span><span class="p">(</span>
            <span class="n">scenario_index</span><span class="p">,</span>
            <span class="n">perturbation</span><span class="p">,</span>
            <span class="n">res</span><span class="p">,</span>
            <span class="n">res_dcpf</span><span class="p">,</span>
            <span class="n">include_dc_res</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">local_processed_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">pf_data</span><span class="p">[</span><span class="s2">&quot;bus&quot;</span><span class="p">],</span>
                <span class="n">pf_data</span><span class="p">[</span><span class="s2">&quot;gen&quot;</span><span class="p">],</span>
                <span class="n">pf_data</span><span class="p">[</span><span class="s2">&quot;branch&quot;</span><span class="p">],</span>
                <span class="n">pf_data</span><span class="p">[</span><span class="s2">&quot;Y_bus&quot;</span><span class="p">],</span>
                <span class="n">pf_data</span><span class="p">[</span><span class="s2">&quot;runtime&quot;</span><span class="p">],</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">local_processed_data</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="process_scenario_chunk"><code>process_scenario_chunk</code><a class="headerlink" href="#process_scenario_chunk" title="Permanent link">&para;</a></h3>


<div class="doc doc-object doc-function">



<a id="gridfm_datakit.process.process_network.process_scenario_chunk"></a>
    <div class="doc doc-contents first">

        <p>Process a chunk of scenarios for distributed processing.</p>
<p>This function processes multiple scenarios in a single worker process,
accumulating results before returning them to the main process.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mode</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Processing mode ("opf" or "pf").</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_idx</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Starting scenario index (inclusive).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>end_idx</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ending scenario index (exclusive).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scenarios</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Array of load scenarios with shape (n_loads, n_scenarios, 2).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>net</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="gridfm_datakit.network.Network" href="../network/#gridfm_datakit.network.Network">Network</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The power network.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>progress_queue</code>
            </td>
            <td>
                  <code><span title="queue.Queue">Queue</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Queue for reporting progress to main process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>topology_generator</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="gridfm_datakit.perturbations.topology_perturbation.TopologyGenerator" href="../topology/#gridfm_datakit.perturbations.topology_perturbation.TopologyGenerator">TopologyGenerator</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Generator for topology perturbations.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>generation_generator</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="gridfm_datakit.perturbations.generator_perturbation.GenerationGenerator" href="../generator_perturbation/#gridfm_datakit.perturbations.generator_perturbation.GenerationGenerator">GenerationGenerator</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Generator for generation cost perturbations.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>admittance_generator</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="gridfm_datakit.perturbations.admittance_perturbation.AdmittanceGenerator" href="../admittance_perturbation/#gridfm_datakit.perturbations.admittance_perturbation.AdmittanceGenerator">AdmittanceGenerator</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Generator for line admittance perturbations.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>error_log_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to error log file for recording failures.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_dc_res</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include DC power flow results in output.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pf_fast</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use fast AC PF solver.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dcpf_fast</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use fast DC PF solver.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>solver_log_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory for solver logs.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_iter</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum iterations for the solver.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>seed</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Global random seed for reproducibility.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="typing.Union">Union</span>[None, <span title="Exception">Exception</span>], <span title="typing.Union">Union</span>[None, <span title="str">str</span>], <span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="numpy.ndarray">ndarray</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple containing:
- Exception object (None if successful)
- Traceback string (None if successful)
- List of processed data tuples (bus, gen, branch, Y_bus arrays)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>gridfm_datakit/process/process_network.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">process_scenario_chunk</span><span class="p">(</span>
    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">start_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">end_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">scenarios</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">net</span><span class="p">:</span> <span class="n">Network</span><span class="p">,</span>
    <span class="n">progress_queue</span><span class="p">:</span> <span class="n">Queue</span><span class="p">,</span>
    <span class="n">topology_generator</span><span class="p">:</span> <span class="n">TopologyGenerator</span><span class="p">,</span>
    <span class="n">generation_generator</span><span class="p">:</span> <span class="n">GenerationGenerator</span><span class="p">,</span>
    <span class="n">admittance_generator</span><span class="p">:</span> <span class="n">AdmittanceGenerator</span><span class="p">,</span>
    <span class="n">error_log_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">include_dc_res</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">pf_fast</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">dcpf_fast</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">solver_log_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">max_iter</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
    <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">],</span>
    <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
    <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]],</span>
<span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process a chunk of scenarios for distributed processing.</span>

<span class="sd">    This function processes multiple scenarios in a single worker process,</span>
<span class="sd">    accumulating results before returning them to the main process.</span>

<span class="sd">    Args:</span>
<span class="sd">        mode: Processing mode (&quot;opf&quot; or &quot;pf&quot;).</span>
<span class="sd">        start_idx: Starting scenario index (inclusive).</span>
<span class="sd">        end_idx: Ending scenario index (exclusive).</span>
<span class="sd">        scenarios: Array of load scenarios with shape (n_loads, n_scenarios, 2).</span>
<span class="sd">        net: The power network.</span>
<span class="sd">        progress_queue: Queue for reporting progress to main process.</span>
<span class="sd">        topology_generator: Generator for topology perturbations.</span>
<span class="sd">        generation_generator: Generator for generation cost perturbations.</span>
<span class="sd">        admittance_generator: Generator for line admittance perturbations.</span>
<span class="sd">        error_log_path: Path to error log file for recording failures.</span>
<span class="sd">        include_dc_res: Whether to include DC power flow results in output.</span>
<span class="sd">        pf_fast: Whether to use fast AC PF solver.</span>
<span class="sd">        dcpf_fast: Whether to use fast DC PF solver.</span>
<span class="sd">        solver_log_dir: Directory for solver logs.</span>
<span class="sd">        max_iter: Maximum iterations for the solver.</span>
<span class="sd">        seed: Global random seed for reproducibility.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple containing:</span>
<span class="sd">            - Exception object (None if successful)</span>
<span class="sd">            - Traceback string (None if successful)</span>
<span class="sd">            - List of processed data tuples (bus, gen, branch, Y_bus arrays)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">jl</span> <span class="o">=</span> <span class="n">init_julia</span><span class="p">(</span><span class="n">max_iter</span><span class="p">,</span> <span class="n">solver_log_dir</span><span class="p">)</span>
        <span class="n">local_processed_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Use custom_seed to set seed based on start_idx for this chunk</span>
        <span class="c1"># This ensures each chunk gets a unique but deterministic seed</span>
        <span class="c1"># we multiply by 20_000 to ensure there is no collision with other runs where the seed would be close to each other</span>
        <span class="c1"># example (assuming we have chunks of length 1, hence an increment of 1 between start indices)</span>
        <span class="c1"># Run A: base seed = 42  scenario seeds = 42, 43, 44, , 10041 (for 10,000 scenarios)</span>
        <span class="c1"># Run B: base seed = 120  scenario seeds = 120, 121, 122, , 10119</span>
        <span class="c1"># These sets overlap on seeds 120..10041 (so 9,922 overlapping seeds).</span>
        <span class="c1"># we also add 1 in case the seed is 0, to not have collision witht he seed used for the load perturbations</span>
        <span class="k">with</span> <span class="n">custom_seed</span><span class="p">(</span><span class="n">seed</span> <span class="o">*</span> <span class="mi">20_000</span> <span class="o">+</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">scenario_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;opf&quot;</span><span class="p">:</span>
                    <span class="n">local_processed_data</span> <span class="o">=</span> <span class="n">process_scenario_opf_mode</span><span class="p">(</span>
                        <span class="n">net</span><span class="p">,</span>
                        <span class="n">scenarios</span><span class="p">,</span>
                        <span class="n">scenario_index</span><span class="p">,</span>
                        <span class="n">topology_generator</span><span class="p">,</span>
                        <span class="n">generation_generator</span><span class="p">,</span>
                        <span class="n">admittance_generator</span><span class="p">,</span>
                        <span class="n">local_processed_data</span><span class="p">,</span>
                        <span class="n">error_log_path</span><span class="p">,</span>
                        <span class="n">include_dc_res</span><span class="p">,</span>
                        <span class="n">jl</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;pf&quot;</span><span class="p">:</span>
                    <span class="n">local_processed_data</span> <span class="o">=</span> <span class="n">process_scenario_pf_mode</span><span class="p">(</span>
                        <span class="n">net</span><span class="p">,</span>
                        <span class="n">scenarios</span><span class="p">,</span>
                        <span class="n">scenario_index</span><span class="p">,</span>
                        <span class="n">topology_generator</span><span class="p">,</span>
                        <span class="n">generation_generator</span><span class="p">,</span>
                        <span class="n">admittance_generator</span><span class="p">,</span>
                        <span class="n">local_processed_data</span><span class="p">,</span>
                        <span class="n">error_log_path</span><span class="p">,</span>
                        <span class="n">include_dc_res</span><span class="p">,</span>
                        <span class="n">pf_fast</span><span class="p">,</span>
                        <span class="n">dcpf_fast</span><span class="p">,</span>
                        <span class="n">jl</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="n">progress_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># update queue</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">local_processed_data</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">error_log_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Caught an exception in process_scenario_chunk function: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">end_idx</span> <span class="o">-</span> <span class="n">start_idx</span><span class="p">):</span>
            <span class="n">progress_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">e</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.indexes", "navigation.tracking", "toc.follow", "toc.follow", "search.suggest", "navigation.instant", "navigation.instant.progress"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../javascripts/katex.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/katex.min.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/contrib/auto-render.min.js"></script>
      
    
  </body>
</html>